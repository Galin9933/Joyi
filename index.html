<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="theme-color" content="#ec4899"/>
    <meta name="description" content="JoyiNovel - Baca ribuan cerita novel favoritmu di mana saja.">
    <link rel="apple-touch-icon" href="images/icon-192x192.png">
    <link rel="manifest" href="manifest.json">

    <title>Joyi Novel - Baca Cerita Favoritmu</title>
    
    <script src="https://cdn.tailwindcss.com?plugins=aspect-ratio"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .slider-container {
            scroll-snap-type: x mandatory;
            scroll-behavior: smooth;
        }
        .sponsored-card-wrapper {
            scroll-snap-align: center;
        }
        .slider-track { 
            will-change: transform; 
            animation: scroll 30s linear infinite;
        }
        @keyframes scroll { 
            from { transform: translateX(0); } 
            to { transform: translateX(-50%); } 
        }
        .slider-container:hover .slider-track,
        .slider-container:active .slider-track {
            animation-play-state: paused;
        }

        .page, .modal { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .modal-content { animation: slideUp 0.3s ease-in-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .novel-card, .author-card, .genre-tag { cursor: pointer; }
        .interactive-cover-container { transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .interactive-cover-container:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .interactive-cover-container img { transition: transform 0.3s ease; }
        .interactive-cover-container:hover img { transform: scale(1.05); }
        .detail-cover-wrapper { perspective: 1000px; }
        .detail-cover { transform: rotateY(-5deg); transition: transform 0.5s ease; box-shadow: -10px 10px 30px rgba(0,0,0,0.2); }
        .detail-cover-wrapper:hover .detail-cover { transform: rotateY(0deg); }
        .reader-content { user-select: none; -webkit-user-select: none; }
        .reader-content p { margin-bottom: 1.5em; line-height: 1.8; }
        #pen-name-field-register { display: none; }
        #comment-drawer-content {
            transition: transform 0.3s ease-in-out;
        }
        .promo-spotlight-card {
            background: linear-gradient(135deg, #fdf2f8 0%, #fce7f3 100%);
            border: 1px solid #fbcfe8;
            position: relative;
            overflow: hidden;
        }
        .promo-spotlight-card::before {
            content: '';
            position: absolute;
            top: -50px;
            left: -80px;
            width: 150px;
            height: 150px;
            background: radial-gradient(circle, rgba(236, 72, 153, 0.1), transparent 70%);
            transition: transform 0.5s ease;
        }
        .promo-spotlight-card:hover::before {
            transform: scale(1.2);
        }
        .promo-sash {
            position: absolute;
            top: -2px;
            right: 12px;
            background-color: #ec4899;
            color: white;
            padding: 12px 8px 4px 8px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            clip-path: polygon(0 0, 100% 0, 100% 100%, 50% 85%, 0 100%);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div id="loading-indicator" class="flex items-center justify-center h-screen w-full max-w-sm">
        <div class="text-center">
            <h1 class="text-3xl font-bold text-pink-600">JoyiNovel</h1>
            <p class="text-slate-500 mt-2 animate-pulse">Memuat cerita untukmu...</p>
        </div>
    </div>
    
    <main id="page-auth" class="page hidden absolute inset-0 overflow-y-auto hide-scrollbar p-4 bg-gray-50 flex items-center justify-center"></main>

    <div id="app-container" class="w-full max-w-sm h-screen bg-white shadow-2xl rounded-lg overflow-hidden flex flex-col relative hidden">

        <header id="main-header" class="flex items-center justify-between p-4 bg-white/80 backdrop-blur-sm border-b border-pink-100 z-10"></header>

        <div id="content-container" class="flex-grow overflow-hidden relative">
            <main id="page-beranda" class="page absolute inset-0 overflow-y-auto hide-scrollbar pb-24 bg-gray-50">
                <div class="p-4 space-y-8">
                </div>
            </main>

            <main id="page-jelajah" class="page hidden absolute inset-0 overflow-y-auto hide-scrollbar p-4 pb-24 bg-gray-50">
                <div class="relative mb-4"><input type="search" id="search-input" placeholder="Cari judul atau penulis..." class="w-full pl-10 pr-4 py-2 border rounded-full bg-white shadow-sm focus:ring-2 focus:ring-pink-300 focus:outline-none"><i data-lucide="search" class="w-5 h-5 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2"></i></div>
                <div id="jelajah-grid" class="grid grid-cols-4 gap-3"></div>
                <div id="pagination-controls" class="flex justify-center items-center gap-2 mt-6"></div>
            </main>
            <main id="page-pustaka" class="page hidden absolute inset-0 overflow-y-auto hide-scrollbar p-4 pb-24 bg-gray-50"><div id="pustaka-content" class="space-y-4"></div></main>

            <main id="page-profil" class="page hidden absolute inset-0 overflow-y-auto hide-scrollbar p-4 pb-24 bg-gray-50">
                <div class="text-center pt-8">
                    <img id="profile-avatar" src="https://placehold.co/100x100/fecdd3/44403c?text=A" alt="Avatar" class="w-20 h-20 mx-auto rounded-full border-4 border-white shadow-lg cursor-pointer">
                    <h2 id="profile-pen-name" class="text-xl font-bold text-slate-800 mt-4"></h2>
                    <p id="profile-email" class="text-sm text-slate-500"></p>
                    <p id="profile-role" class="text-sm text-pink-600 font-semibold capitalize mt-2"></p>
                    <div id="profile-options" class="hidden mt-6 space-y-4 transition-all duration-300">
                        <div class="space-y-2 px-6">
                            <label for="pen-name-edit" class="text-xs font-medium text-slate-500 text-left block">Nama Pena</label>
                            <div class="flex gap-2"><input type="text" id="pen-name-edit" class="block w-full px-3 py-1.5 bg-white border rounded-md text-sm shadow-sm focus:outline-none focus:border-pink-500 focus:ring-1 focus:ring-pink-500"><button id="change-pen-name-btn" class="bg-pink-100 text-pink-700 px-3 rounded-md text-sm font-semibold hover:bg-pink-200">Simpan</button></div>
                        </div>
                        <div class="space-y-2 px-6">
                            <label for="avatar-url" class="text-xs font-medium text-slate-500 text-left block">Ganti foto profil (URL)</label>
                            <div class="flex gap-2"><input type="url" id="avatar-url" class="block w-full px-3 py-1.5 bg-white border rounded-md text-sm shadow-sm focus:outline-none focus:border-pink-500 focus:ring-1 focus:ring-pink-500"><button id="change-avatar-btn" class="bg-pink-100 text-pink-700 px-3 rounded-md text-sm font-semibold hover:bg-pink-200">Ganti</button></div>
                        </div>
                        <div class="flex flex-col items-center"><a id="writer-action-button" href="#" class="w-52 bg-pink-500 text-white font-semibold py-2 px-6 rounded-lg shadow-sm hover:bg-pink-600 inline-flex items-center justify-center gap-2 text-sm"></a></div>
                    </div>
                    <div id="admin-ads-container" class="mt-8 space-y-4 px-4"></div>
                    <div class="mt-8 flex flex-col items-center space-y-3">
                        <a id="saldo-koin-button" href="#" class="w-52 bg-sky-500 text-white font-semibold py-2 px-6 rounded-lg shadow-sm hover:bg-sky-600 inline-flex items-center justify-center gap-2 text-sm"><i data-lucide="wallet" class="w-4 h-4"></i> Saldo Koin</a>
                        <a id="buy-coin-button" href="#" class="w-52 bg-yellow-400 text-yellow-900 font-semibold py-2 px-6 rounded-lg shadow-sm hover:bg-yellow-500 inline-flex items-center justify-center gap-2 text-sm"><i data-lucide="gem" class="w-4 h-4"></i> Beli Koin</a>
                        <a id="contact-admin-button" href="#" target="_blank" class="w-52 bg-green-500 text-white font-semibold py-2 px-6 rounded-lg shadow-sm hover:bg-green-600 inline-flex items-center justify-center gap-2 text-sm"><i data-lucide="message-circle" class="w-4 h-4"></i> Hubungi Admin</a>
                        <button id="logout-btn" class="w-52 bg-slate-200 text-slate-800 font-semibold py-2 px-6 rounded-lg shadow-sm hover:bg-slate-300 inline-flex items-center justify-center gap-2 text-sm"><i data-lucide="log-out" class="w-4 h-4"></i> Keluar</button>
                    </div>
                </div>
            </main>

            <main id="page-dashboard-penulis" class="page hidden absolute inset-0 overflow-y-auto hide-scrollbar p-4 pb-24 bg-gray-50"><div id="dashboard-earnings-view"></div><div class="flex gap-2 my-4"><button id="give-silver-coin-btn" class="w-full bg-slate-200 text-slate-800 font-semibold py-2.5 px-4 rounded-lg inline-flex items-center justify-center gap-2 text-sm">Beri Koin Perak</button></div><div id="novel-list-view" class="space-y-4"></div><button id="add-novel-btn" class="absolute bottom-28 right-6 bg-pink-500 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center hover:bg-pink-600"><i data-lucide="plus" class="w-8 h-8"></i></button></main>
            <main id="page-tambah-novel" class="page hidden absolute inset-0 overflow-y-auto hide-scrollbar p-4 pb-24 bg-gray-50"><form id="add-novel-form" class="space-y-4"></form></main>
            <main id="page-detail-novel" class="page hidden absolute inset-0 overflow-y-auto hide-scrollbar pb-24 bg-gray-50"><div id="novel-detail-content"></div></main>
            <main id="page-edit-novel" class="page hidden absolute inset-0 overflow-y-auto hide-scrollbar p-4 pb-24 bg-gray-50"><div id="edit-novel-content"></div><button id="add-chapter-btn" class="absolute bottom-28 right-6 bg-pink-500 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center hover:bg-pink-600"><i data-lucide="file-plus-2" class="w-8 h-8"></i></button></main>
            <main id="page-edit-bab" class="page hidden absolute inset-0 overflow-y-auto hide-scrollbar p-4 pb-24 bg-gray-50"><form id="edit-chapter-form" class="space-y-4"></form></main>
            
            <main id="page-beli-koin" class="page hidden absolute inset-0 overflow-y-auto hide-scrollbar p-4 pb-24 bg-gray-50"><div id="buy-coin-content"></div></main>
            <main id="page-saldo" class="page hidden absolute inset-0 overflow-y-auto hide-scrollbar p-4 pb-24 bg-gray-50"><div id="saldo-content" class="space-y-4"></div></main>
            <main id="page-beri-koin-perak" class="page hidden absolute inset-0 overflow-y-auto hide-scrollbar p-4 pb-24 bg-gray-50"><form id="give-silver-coin-form" class="space-y-4"></form></main>

            <main id="page-baca-bab" class="page hidden absolute inset-0 flex flex-col bg-white">
                <div id="reader-toolbar" class="flex justify-between items-center p-2 border-b bg-white/80 backdrop-blur-sm z-10"></div>
                <div id="reader-content-wrapper" class="flex-grow overflow-y-auto p-6 reader-content"></div>
                <div id="reader-footer" class="p-2 border-t bg-gray-50/80 backdrop-blur-sm">
                    <button id="open-comment-drawer-btn" class="w-full text-left p-2 bg-gray-200 rounded-lg text-sm text-slate-600 flex justify-between items-center">
                        <span>Tulis komentar...</span>
                        <div class="flex items-center gap-2">
                            <span id="comment-count-badge" class="text-xs font-semibold">0</span>
                            <i data-lucide="message-square"></i>
                        </div>
                    </button>
                </div>
            </main>
            <main id="page-notifikasi" class="page hidden absolute inset-0 overflow-y-auto hide-scrollbar p-4 pb-24 bg-gray-50"><div id="notification-list" class="space-y-3"></div></main>
        </div>

        <nav id="bottom-nav" class="absolute bottom-0 left-0 right-0 bg-white/90 backdrop-blur-sm border-t border-pink-100 p-2 z-10 rounded-t-lg">
            <div id="nav-container" class="flex justify-around items-center">
                <a href="#beranda" class="nav-item flex flex-col items-center gap-1 text-pink-500 w-1/4"><i data-lucide="home" class="w-6 h-6"></i><span class="text-xs font-semibold">Beranda</span></a>
                <a href="#jelajah" class="nav-item flex flex-col items-center gap-1 text-slate-500 w-1/4"><i data-lucide="compass" class="w-6 h-6"></i><span class="text-xs">Jelajahi</span></a>
                <a href="#pustaka" class="nav-item flex flex-col items-center gap-1 text-slate-500 w-1/4"><i data-lucide="library" class="w-6 h-6"></i><span class="text-xs">Pustaka</span></a>
                <a href="#profil" class="nav-item flex flex-col items-center gap-1 text-slate-500 w-1/4"><i data-lucide="user-round" class="w-6 h-6"></i><span class="text-xs">Profil</span></a>
            </div>
        </nav>

        <div id="comment-drawer" class="absolute inset-0 bg-black/30 z-20 hidden">
            <div id="comment-drawer-content" class="absolute bottom-0 left-0 right-0 h-[75%] bg-white rounded-t-2xl shadow-2xl flex flex-col transform translate-y-full">
                <div class="p-4 border-b">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-bold">Komentar</h3>
                        <button id="close-comment-drawer-btn"><i data-lucide="x"></i></button>
                    </div>
                </div>
                <div id="comment-list-container" class="flex-grow overflow-y-auto p-4 space-y-3">
                </div>
                <div class="p-2 border-t bg-gray-50">
                    <form id="comment-form" class="flex gap-2">
                        <input type="text" id="comment-input" required class="w-full px-3 py-2 bg-white border rounded-lg text-sm" placeholder="Tulis komentar...">
                        <button type="submit" class="bg-pink-500 text-white px-4 rounded-lg flex items-center justify-center"><i data-lucide="send"></i></button>
                    </form>
                </div>
            </div>
        </div>

    </div>

    <div id="writer-signup-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4"><div class="modal-content bg-white rounded-lg shadow-xl p-6 text-center w-full max-w-xs"><i data-lucide="send" class="w-16 h-16 text-green-500 mx-auto"></i><h3 class="text-lg font-bold text-slate-800 mt-4">Permintaan Terkirim!</h3><p class="text-sm text-slate-500 mt-2">Hubungi admin untuk proses verifikasi.</p><button id="close-modal-btn" class="mt-6 w-full bg-pink-500 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-pink-600">Mengerti</button></div></div>
    <div id="unlock-chapter-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4"><div id="unlock-chapter-modal-content" class="modal-content relative bg-white rounded-lg shadow-xl p-6 w-full max-w-xs"></div></div>
    <div id="coin-info-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4"><div id="coin-info-modal-content" class="modal-content relative bg-white rounded-lg shadow-xl p-6 w-full max-w-xs"></div></div>

    <script type="module">
        // Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, getDoc, setDoc, addDoc, updateDoc, where, query, writeBatch, increment, orderBy, limit, startAfter } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
        
        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);

        // --- START: FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyAi4Nf5eJYCopdya6sQdbkgee-7Cx-6dYM",
            authDomain: "joyi-novel.firebaseapp.com",
            databaseURL: "https://joyi-novel-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "joyi-novel",
            storageBucket: "joyi-novel.appspot.com",
            messagingSenderId: "277323471062",
            appId: "1:277323471062:web:a44f20e55847e7cdb45177",
            measurementId: "G-T56BK7V642"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Global State Variables ---
        let allNovels = [];
        let currentUser = null;
        let libraryNovelIds = [];
        let unlockedChapterIds = [];
        let dummyAuthors = [];
        let readerSettings = { fontSize: 1, theme: 'light' };
        
        // --- State for Dynamic Admin Features ---
        let adSlots = [];
        let homepageLayout = [];
        let allNotifications = [];
        
        // --- State for Pagination ---
        let totalNovels = 0;
        let pageHistory = [null];
        let currentPage = 1;
        const jelajahItemsPerPage = 12;

        const fontSizes = ['text-sm', 'text-base', 'text-lg', 'text-xl', 'text-2xl'];
        
        const shuffleArray = (a) => { let c=a.length,r; const n=[...a]; while(c!==0){r=Math.floor(Math.random()*c);c--;[n[c],n[r]]=[n[r],n[c]]} return n };
        function showToast(m){const t=document.createElement('div');t.className='fixed bottom-24 left-1/2 -translate-x-1/2 bg-slate-800 text-white text-sm py-2 px-4 rounded-full shadow-lg z-50';t.textContent=m;document.body.appendChild(t);setTimeout(()=>{t.style.opacity='0';setTimeout(()=>t.remove(),300)},3000)}
        
        async function logAdView(type, novelId = null) {
            if (!currentUser) return;
            try {
                await addDoc(collection(db, "ad_views"), {
                    userId: currentUser.uid,
                    adType: type, // 'novel' atau 'profile'
                    novelId: novelId,
                    timestamp: new Date()
                });
                console.log(`Ad view logged: ${type}`);
            } catch (error) {
                console.error("Gagal mencatat tayangan iklan:", error);
            }
        }

        async function incrementNovelClickCount(novelId) {
            if (!novelId) return;
            try {
                const novelRef = doc(db, "novels", novelId);
                await updateDoc(novelRef, { clickCount: increment(1) });
            } catch (error) {
                console.error("Gagal memperbarui click count: ", error);
            }
        }

        function copyToClipboardFallback(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.top = "-9999px";
            textArea.style.left = "-9999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                showToast('Link promosi novel berhasil disalin!');
            } catch (err) {
                console.error('Gagal menyalin link: ', err);
                showToast('Gagal menyalin link.');
            }
            document.body.removeChild(textArea);
        }

        function getFriendlyAuthError(errorCode) {
            switch (errorCode) {
                case 'auth/invalid-email': return 'Format email tidak valid.';
                case 'auth/user-not-found': return 'Email tidak terdaftar.';
                case 'auth/wrong-password': return 'Password salah.';
                case 'auth/email-already-in-use': return 'Email sudah digunakan oleh akun lain.';
                case 'auth/weak-password': return 'Password terlalu lemah (minimal 6 karakter).';
                default: return 'Terjadi kesalahan. Coba lagi.';
            }
        }

        const createAuthPage = () => {
            return `
                <div class="w-full max-w-xs">
                    <div class="text-center mb-8">
                        <h1 class="text-3xl font-bold text-pink-600">JoyiNovel</h1>
                        <p class="text-slate-500 mt-1">Masuk atau Daftar untuk melanjutkan</p>
                    </div>
                    <form id="auth-form" class="bg-white shadow-md rounded-lg px-8 pt-6 pb-8 mb-4">
                        <div class="mb-4">
                            <label class="block text-slate-700 text-sm font-bold mb-2" for="email">Email</label>
                            <input class="shadow appearance-none border rounded w-full py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-pink-300" id="auth-email" type="email" placeholder="email@example.com" required>
                        </div>
                        <div class="mb-4" id="pen-name-field-register">
                            <label class="block text-slate-700 text-sm font-bold mb-2" for="pen-name">Nama Pena</label>
                            <input class="shadow appearance-none border rounded w-full py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-pink-300" id="auth-pen-name" type="text" placeholder="Nama Pena Anda" required>
                        </div>
                        <div class="mb-6">
                            <label class="block text-slate-700 text-sm font-bold mb-2" for="password">Password</label>
                            <input class="shadow appearance-none border rounded w-full py-2 px-3 text-slate-700 mb-3 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-pink-300" id="auth-password" type="password" placeholder="******************" required minlength="6">
                        </div>
                        <div id="auth-error" class="text-red-500 text-xs italic mb-4 text-center h-4"></div>
                        <div class="flex flex-col gap-3">
                            <button id="login-btn" class="bg-pink-500 hover:bg-pink-600 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline" type="button">Masuk</button>
                            <button id="show-register-form-btn" class="text-sm text-pink-600 hover:underline" type="button">Belum punya akun? Daftar</button>
                            <button id="register-btn" class="hidden bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline" type="button">Daftar Akun Baru</button>
                        </div>
                    </form>
                </div>
            `;
        };

        const createNovelCard=(n,t='recommendation')=>`<div class="novel-card flex items-center gap-4 p-3 bg-white rounded-xl shadow-sm" data-novel-id="${n.id}"><div class="w-16 h-20 rounded-md flex-shrink-0 overflow-hidden interactive-cover-container"><img src="${n.coverUrl}" class="w-full h-full object-cover"></div><div class="flex-1"><h4 class="font-bold text-slate-800">${n.title}</h4><p class="text-xs text-slate-500 mt-1 mb-2 line-clamp-2">${n.description}</p><div class="flex gap-2">${(n.tags || []).map(g=>`<span class="genre-tag text-xs bg-pink-100 text-pink-700 px-2 py-0.5 rounded-full hover:bg-pink-200" data-genre="${g.name}">${g.name}</span>`).join('')}</div></div> ${t==='library'?`<button class="delete-library-btn" data-novel-id="${n.id}"><i data-lucide="trash-2" class="w-5 h-5 text-slate-400"></i></button>`:''}</div>`;
        
        // --- [FIX #1 - PROMOTION] ---
        // Memperbaiki logika untuk mengecek apakah promosi masih aktif.
        const createMyNovelCard = (n, earnings) => {
            const clickCount = n.clickCount || 0;
            
            let isCurrentlyPromoted = false;
            if (n.isPromoted && n.promotedAt && typeof n.promotedAt.toDate === 'function') {
                const promotedTime = n.promotedAt.toDate();
                const expiryTime = new Date(promotedTime.getTime() + (24 * 60 * 60 * 1000));
                if (new Date() < expiryTime) {
                    isCurrentlyPromoted = true;
                }
            }

            return `<div class="bg-white rounded-xl shadow-sm p-3">
                <div class="flex items-center gap-4">
                    <div class="w-16 h-20 rounded-md flex-shrink-0 overflow-hidden interactive-cover-container">
                        <img src="${n.coverUrl}" class="w-full h-full object-cover">
                    </div>
                    <div class="flex-1 novel-card" data-novel-id="${n.id}">
                        <h4 class="font-bold text-slate-800">${n.title}</h4>
                        <p class="text-xs text-slate-500">${n.status}</p>
                        <div class="flex items-center gap-4 mt-1 text-xs">
                            <span class="font-semibold text-green-600">Rp ${(earnings || 0).toLocaleString('id-ID')}</span>
                            <span class="flex items-center gap-1 text-slate-500 font-medium">
                                <i data-lucide="eye" class="w-3.5 h-3.5"></i> ${clickCount.toLocaleString('id-ID')}
                            </span>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <button class="edit-novel-btn p-2 rounded-full hover:bg-slate-100" data-novel-id="${n.id}" title="Edit Novel"><i data-lucide="edit" class="w-5 h-5 text-slate-500"></i></button>
                        <button class="share-novel-btn p-2 rounded-full hover:bg-slate-100" data-novel-id="${n.id}" title="Bagikan Novel"><i data-lucide="share-2" class="w-5 h-5 text-slate-500"></i></button>
                    </div>
                </div>
                <div class="mt-2 pt-2 border-t">
                    <button class="promote-novel-btn w-full text-sm font-semibold text-pink-600 flex items-center justify-center gap-2 ${isCurrentlyPromoted ? 'opacity-50 cursor-not-allowed' : ''}" data-novel-id="${n.id}" ${isCurrentlyPromoted ? 'disabled' : ''}>
                        <i data-lucide="rocket" class="w-4 h-4"></i>${isCurrentlyPromoted ? 'Promosi Aktif' : 'Promosikan Novel'}
                    </button>
                </div>
            </div>`;
        };

        const createTrendingCard=(n)=>`<div class="novel-card flex-shrink-0 w-20 text-center group" data-novel-id="${n.id}"><div class="rounded-lg shadow-md mb-2 overflow-hidden interactive-cover-container"><img src="${n.coverUrl}" class="w-full h-28 object-cover"></div><h4 class="font-semibold text-sm text-slate-700 truncate">${n.title}</h4><p class="text-xs text-slate-500">${n.authorPenName || n.author.split('@')[0]}</p></div>`;
        const createJelajahCard=(n)=>`<div class="novel-card text-center group" data-novel-id="${n.id}"><div class="rounded-lg shadow-md mb-2 overflow-hidden interactive-cover-container"><img src="${n.coverUrl}" class="w-full h-32 object-cover"></div><h4 class="font-semibold text-sm text-slate-700 truncate">${n.title}</h4><p class="text-xs text-slate-500">${n.authorPenName || n.author.split('@')[0]}</p></div>`;
        const createAuthorProfileCard=(a)=>`<div class="author-card flex-shrink-0 w-20 text-center" data-author="${a.name}"><img src="${a.avatarUrl}" class="w-16 h-16 object-cover rounded-full shadow-md mb-2 mx-auto border-2"><h4 class="font-semibold text-xs text-slate-700 truncate">${a.name}</h4></div>`;
        
        const createSponsoredBannerCard = (n) => `
            <div class="sponsored-card-wrapper flex-shrink-0 w-[90%]">
                <div class="novel-card bg-white rounded-2xl shadow-lg p-3 flex gap-4 items-center promo-spotlight-card" data-novel-id="${n.id}">
                    <img src="${n.coverUrl}" class="w-28 h-40 object-cover rounded-lg flex-shrink-0 shadow-md transform group-hover:scale-105 transition-transform duration-300">
                    <div class="overflow-hidden z-10">
                        <h4 class="font-bold text-lg text-slate-800 truncate">${n.title}</h4>
                        <p class="text-sm text-pink-700 font-medium">${n.authorPenName || n.author.split('@')[0]}</p>
                        <p class="text-xs text-slate-500 mt-2 line-clamp-2">${n.description}</p>
                        <div class="mt-3">
                            <span class="text-sm font-semibold text-pink-600 hover:text-pink-700">Lihat Cerita &rarr;</span>
                        </div>
                    </div>
                    <div class="promo-sash">Pilihan<br>Editor</div>
                </div>
            </div>`;

        const createNovelDetailPage=(n)=>{const sC=n.status==='Tamat'?'bg-green-100 text-green-800':'bg-yellow-100 text-yellow-800';const publishedChapters = (n.chapters || []).filter(c => c.status !== 'draft'); return `<div class="p-4 space-y-4"><div class="flex gap-4"><div class="detail-cover-wrapper flex-shrink-0"><img src="${n.coverUrl}" class="w-28 h-40 object-cover rounded-lg shadow-lg detail-cover"></div><div class="space-y-1.5"><h2 class="text-xl font-bold text-slate-800">${n.title}</h2><p class="text-sm font-medium text-pink-600 cursor-pointer hover:underline author-link" data-author="${n.authorPenName || n.author}">${n.authorPenName || n.author.split('@')[0]}</p><div class="flex flex-wrap gap-2 pt-1">${(n.tags || []).map(g=>`<span class="genre-tag text-xs bg-pink-100 text-pink-700 px-2 py-1 rounded-full hover:bg-pink-200" data-genre="${g.name}">${g.name}</span>`).join('')}</div><span class="text-xs font-semibold px-2.5 py-1 rounded-full inline-block ${sC}">${n.status}</span></div></div><div class="flex gap-2"><button id="add-to-library-btn" data-novel-id="${n.id}" class="w-full bg-pink-500 text-white font-semibold py-2.5 px-4 rounded-lg shadow-md hover:bg-pink-600 inline-flex items-center justify-center gap-2"><i data-lucide="library" class="w-4 h-4"></i>Koleksi</button><button id="share-detail-btn" data-novel-id="${n.id}" class="w-full bg-sky-500 text-white font-semibold py-2.5 px-4 rounded-lg shadow-md hover:bg-sky-600 inline-flex items-center justify-center gap-2"><i data-lucide="share-2" class="w-4 h-4"></i>Salin Link</button></div><div><h3 class="font-bold text-slate-800 mb-1">Sinopsis</h3><p class="text-sm text-slate-600 leading-relaxed">${n.description}</p></div><div><h3 class="font-bold text-slate-800 mb-2">Daftar Bab</h3><div class="bg-white rounded-lg border overflow-hidden">${publishedChapters.length > 0 ? publishedChapters.map(c=>{const isAdSupported = n.monetizationModel === 'ads'; const isUnlocked=isAdSupported || c.monetization==='free'||unlockedChapterIds.includes(c.id); const icon=isUnlocked?`<i data-lucide="unlock" class="w-4 h-4 text-green-500"></i>`:`<i data-lucide="gem" class="w-4 h-4 text-yellow-500"></i>`; return `<a href="#" class="chapter-link flex justify-between items-center p-3 border-b hover:bg-slate-50 text-sm text-slate-700" data-novel-id="${n.id}" data-chapter-id="${c.id}"><span>${c.title}</span>${icon}</a>`}).join('') : `<p class="p-3 text-sm text-slate-400">Belum ada bab.</p>`}</div></div></div>`};
        
        const createEditNovelPage=(n)=>{
            return `
            <div class="mb-6">
                <h3 class="font-bold text-slate-800 mb-2">Edit Detail Novel</h3>
                <form id="edit-novel-form" class="bg-white rounded-lg border p-4 space-y-4">
                    <div>
                        <label for="edit-novel-title" class="text-sm font-medium text-slate-700">Judul Novel</label>
                        <input type="text" id="edit-novel-title" required class="mt-1 block w-full px-3 py-2 bg-white border rounded-md text-sm shadow-sm focus:outline-none focus:border-pink-500 focus:ring-1 focus:ring-pink-500">
                    </div>
                    <div>
                        <label for="edit-novel-synopsis" class="text-sm font-medium text-slate-700">Sinopsis</label>
                        <textarea id="edit-novel-synopsis" rows="5" required class="mt-1 block w-full px-3 py-2 bg-white border rounded-md text-sm shadow-sm focus:outline-none focus:border-pink-500 focus:ring-1 focus:ring-pink-500"></textarea>
                    </div>
                    <div>
                        <label for="edit-novel-tags" class="text-sm font-medium text-slate-700">Genre</label>
                        <input type="text" id="edit-novel-tags" required class="mt-1 block w-full px-3 py-2 bg-white border rounded-md text-sm shadow-sm focus:outline-none focus:border-pink-500 focus:ring-1 focus:ring-pink-500">
                        <p class="text-xs text-slate-500 mt-1">Pisahkan setiap genre dengan koma (contoh: Romantis, Fantasi).</p>
                    </div>
                    <button type="submit" class="w-full bg-pink-500 text-white font-semibold py-2.5 px-4 rounded-lg shadow-md hover:bg-pink-600">Simpan Perubahan</button>
                </form>
            </div>
            <div>
                <h3 class="font-bold text-slate-800 mb-2">Kelola Bab</h3>
                <div class="bg-white rounded-lg border overflow-hidden" id="chapter-list-container">
                    ${(n.chapters || []).map(c=>`<div class="flex justify-between items-center p-3 border-b"><div class="flex-1"><p class="font-semibold text-slate-700">${c.title}</p><div class="flex items-center gap-4 text-xs text-slate-500 mt-1"><span class="font-semibold ${c.status === 'draft' ? 'text-yellow-600' : 'text-green-600'}">${c.status === 'draft' ? 'Draf' : 'Terbit'}</span><span>Monetisasi: ${c.monetization==='free'?'Gratis':'Premium'}</span></div></div><button class="edit-chapter-btn" data-chapter-id="${c.id}"><i data-lucide="edit" class="w-5 h-5 text-slate-500"></i></button></div>`).join('')||`<p class="p-3 text-sm text-slate-400">Belum ada bab.</p>`}
                </div>
            </div>
            `;
        };
        
        const createEditChapterForm=(c={}, n={})=>{
            const isAdSupportedNovel = n.monetizationModel === 'ads';
            const monetizationUI = isAdSupportedNovel
                ? `<div class="p-3 bg-green-50 border-l-4 border-green-400 rounded-r-lg text-xs text-green-800">Novel ini gratis dan didukung oleh iklan. Semua bab akan dapat diakses secara gratis.</div>`
                : `<div><label class="text-sm font-medium text-slate-700">Monetisasi</label><label class="inline-flex items-center cursor-pointer mt-2"><input type="checkbox" id="monetize-toggle" class="sr-only peer" ${c.monetization === 'paid' ?'checked':''}><div class="relative w-11 h-6 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-pink-500"></div><span class="ms-3 text-sm font-medium text-gray-900">Jadikan Bab Premium (10 Koin)</span></label></div>`;
            
            $('#edit-chapter-form').innerHTML=`<input type="hidden" id="chapter-form-novel-id" value="${n.id || ''}"><div><div class="p-3 bg-blue-50 border-l-4 border-blue-400 rounded-r-lg text-xs text-blue-800 mb-4"><b>Saran:</b> Sediakan setidaknya 5-10 bab gratis untuk menarik minat pembaca sebelum memonetisasi bab selanjutnya.</div><label class="text-sm font-medium text-slate-700">Judul Bab</label><input type="text" id="chapter-title" required class="mt-1 block w-full px-3 py-2 bg-white border rounded-md text-sm shadow-sm" value="${c.title||''}"></div><div><label class="text-sm font-medium text-slate-700">Konten Bab</label><textarea id="chapter-content" rows="15" class="mt-1 block w-full px-3 py-2 bg-white border rounded-md text-sm shadow-sm">${c.content || ''}</textarea><div id="word-count" class="text-xs text-right text-slate-500 mt-1">0/1000 kata minimum</div></div><div><label for="ai-percentage" class="text-sm font-medium text-slate-700 flex justify-between"><span>Analisis Konten (Manusia vs AI)</span><span id="ai-percentage-label">${c.ai_percent||10}% AI</span></label><input type="range" id="ai-percentage" min="0" max="100" value="${c.ai_percent||10}" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"></div>${monetizationUI}<div class="mt-4 p-2 bg-red-50 text-xs text-red-700 rounded-md"><b>Info:</b> Penghapusan bab atau novel hanya dapat dilakukan oleh Admin.</div><div class="mt-6 flex gap-3"><button type="submit" data-action="draft" class="w-full bg-slate-200 text-slate-800 font-semibold py-2.5 px-4 rounded-lg hover:bg-slate-300">Simpan Draf</button><button type="submit" data-action="publish" class="w-full bg-pink-500 text-white font-semibold py-2.5 px-4 rounded-lg shadow-md hover:bg-pink-600">Publikasi</button></div>`;};
        
        const createUnlockModal=(c,n)=>{const silverBalance = currentUser.balance.silver[n.authorPenName] || 0; const goldBalance = currentUser.balance.gold || 0; const canUnlockSilver = silverBalance >= 10; const canUnlockGold = goldBalance >= 10; return `<button class="close-modal-btn absolute top-2 right-2 p-1 rounded-full hover:bg-slate-200"><i data-lucide="x" class="w-5 h-5 text-slate-500"></i></button><div class="text-center"><i data-lucide="lock" class="w-12 h-12 text-yellow-500 mx-auto"></i><h3 class="text-lg font-bold text-slate-800 mt-4">Buka Bab Premium</h3><p class="text-sm text-slate-500 mt-2">Anda perlu membuka bab ini untuk melanjutkan membaca.</p></div><div class="mt-6 space-y-2"><button data-coin-type="silver" data-can-unlock="${canUnlockSilver}" class="unlock-with-coin-btn w-full font-semibold py-2.5 px-4 rounded-lg inline-flex items-center justify-center gap-2 ${canUnlockSilver ? 'bg-slate-200 text-slate-800' : 'bg-slate-100 text-slate-400'}">${canUnlockSilver ? 'Buka dengan 10' : 'Koin Perak Habis'} <i data-lucide="coins" class="w-4 h-4 text-yellow-600"></i></button><button data-coin-type="gold" data-can-unlock="${canUnlockGold}" class="unlock-with-coin-btn w-full font-semibold py-2.5 px-4 rounded-lg inline-flex items-center justify-center gap-2 ${canUnlockGold ? 'bg-yellow-400 text-yellow-900' : 'bg-yellow-100 text-yellow-400'}">${canUnlockGold ? 'Buka dengan 10' : 'Koin Emas Habis'} <i data-lucide="gem" class="w-4 h-4"></i></button></div>`};
        const createCoinInfoModal = (authorPhone) => { return `<button class="close-modal-btn absolute top-2 right-2 p-1 rounded-full hover:bg-slate-200"><i data-lucide="x" class="w-5 h-5 text-slate-500"></i></button><div class="text-center"><i data-lucide="coins" class="w-12 h-12 text-sky-500 mx-auto"></i><h3 class="text-lg font-bold text-slate-800 mt-4">Beli Koin</h3><p class="text-sm text-slate-500 mt-2">Pilih jenis koin yang ingin Anda beli.</p></div><div class="mt-4 space-y-3 text-left"><div class="p-3 bg-gray-50 rounded-lg text-xs"><p class="font-semibold text-slate-700">Koin Perak (150 Koin = Rp 10.000)</p><p class="text-slate-500">Hanya bisa digunakan untuk novel dari penulis yang bersangkutan. Hubungi penulis untuk membeli.</p></div><div class="p-3 bg-yellow-50 rounded-lg text-xs"><p class="font-semibold text-yellow-800">Koin Emas (100 Koin = Rp 10.000)</p><p class="text-yellow-700">Bisa digunakan untuk semua novel premium di aplikasi ini.</p></div></div><div class="mt-6 space-y-2"><a href="https://wa.me/${authorPhone}?text=${encodeURIComponent(`Halo kak, saya ingin membeli Koin Perak.`)}" target="_blank" class="w-full block text-center bg-slate-200 text-slate-800 font-semibold py-2.5 px-4 rounded-lg">Beli Koin Perak</a><button id="buy-gold-coin-redirect" class="w-full bg-yellow-400 text-yellow-900 font-semibold py-2.5 px-4 rounded-lg">Beli Koin Emas</button></div>`};

        const createReaderToolbar=(novel, chapter)=>{return `<button id="back-from-reader" class="p-2"><i data-lucide="arrow-left"></i></button><div class="text-center overflow-hidden flex-1"><h4 class="text-sm font-semibold truncate">${novel.title}</h4><p class="text-xs text-slate-500 truncate">${chapter.title}</p></div><button id="reader-settings-btn" class="p-2"><i data-lucide="settings-2"></i></button>`};
        const createReaderSettingsMenu=()=>{return `<div class="p-2 space-y-2"><div class="flex items-center justify-between"><button id="decrease-font" class="px-3 py-1 border rounded-md">Aa-</button><span class="text-sm">Ukuran Font</span><button id="increase-font" class="px-3 py-1 border rounded-md">Aa+</button></div><div class="flex justify-around items-center pt-2"><div id="theme-light" class="w-8 h-8 rounded-full bg-white border-2 border-pink-500 cursor-pointer"></div><div id="theme-sepia" class="w-8 h-8 rounded-full bg-[#fbf5e9] border cursor-pointer"></div><div id="theme-dark" class="w-8 h-8 rounded-full bg-slate-900 border cursor-pointer"></div></div></div>`};
        const createHomePageHeader=(notifications = [])=>{const hasUnread = notifications.some(n => !n.read); $('#main-header').innerHTML=`<div><h1 class="text-2xl font-bold text-slate-800">JoyiNovel</h1><p class="text-xs text-slate-500">Temukan cerita favoritmu</p></div><div class="flex items-center gap-2"><button id="search-btn" class="p-2 rounded-full bg-slate-100 hover:bg-slate-200"><i data-lucide="search" class="w-5 h-5 text-slate-600"></i></button><button id="notification-btn" class="p-2 relative"><i data-lucide="bell" class="w-5 h-5 text-slate-600"></i>${hasUnread ? '<span class="absolute top-1 right-1 block h-2 w-2 rounded-full bg-pink-500 ring-2 ring-white"></span>' : ''}</button></div>`};
        const createNotificationCard = (notif) => `<div class="p-4 rounded-lg ${notif.read ? 'bg-white' : 'bg-pink-50 border-l-4 border-pink-400'} shadow-sm"><p class="font-bold text-slate-800">${notif.title}</p><p class="text-sm text-slate-600 mt-1">${notif.message}</p><p class="text-xs text-slate-400 text-right mt-2">${new Date(notif.createdAt.seconds * 1000).toLocaleString('id-ID')}</p></div>`;
        const createSaldoPage = (balance) => { const silverBalances = Object.entries(balance.silver || {}).sort(([,a],[,b])=>b-a); return `<div><div class="p-4 bg-yellow-50 border-l-4 border-yellow-400 rounded-r-lg flex justify-between items-center"><div class="flex items-center gap-3"><i data-lucide="gem" class="w-8 h-8 text-yellow-500"></i><div><h3 class="font-bold text-yellow-900">Koin Emas</h3><p class="text-xs text-yellow-700">Total saldo Anda</p></div></div><span class="text-2xl font-bold text-yellow-900">${balance.gold || 0}</span></div><button id="topup-gold-btn" class="w-full mt-2 bg-yellow-400 text-yellow-900 font-semibold py-2 rounded-lg text-sm">Top Up Koin Emas</button></div><div class="space-y-3">${silverBalances.map(([author, amount]) => `<div class="bg-white p-4 rounded-lg shadow-sm border"> <div class="flex justify-between items-center"><div><p class="font-semibold text-slate-700">Koin Perak: ${author}</p><p class="text-xs text-slate-500">Hanya untuk novel dari penulis ini</p></div><span class="font-bold text-slate-800 inline-flex items-center gap-1.5">${amount} <i data-lucide="coins" class="w-4 h-4 text-yellow-600"></i></span></div><button class="topup-silver-btn w-full mt-2 bg-slate-200 text-slate-800 font-semibold py-2 rounded-lg text-sm" data-author-name="${author}">Top Up Koin Perak</button></div>`).join('') || '<p class="text-center text-slate-500 mt-4">Anda belum memiliki Koin Perak.</p>'}</div>`};
        const createGiveSilverCoinForm = () => {$('#give-silver-coin-form').innerHTML = `<div><label class="text-sm font-medium text-slate-700">Email Pembaca</label><input type="email" id="reader-email" required class="mt-1 block w-full px-3 py-2 bg-white border rounded-md text-sm shadow-sm"></div><div><label class="text-sm font-medium text-slate-700">Jumlah Koin Perak</label><input type="number" id="silver-amount" required class="mt-1 block w-full px-3 py-2 bg-white border rounded-md text-sm shadow-sm"></div><button type="submit" class="w-full bg-pink-500 text-white font-semibold py-2.5 px-4 rounded-lg shadow-md hover:bg-pink-600">Kirim Koin</button>`};
        const createAdCard = (ad) => `<div class="bg-white rounded-xl shadow-sm border overflow-hidden group"><img src="${ad.imageUrl}" class="w-full h-auto group-hover:scale-105 transition-transform duration-300" alt="${ad.title}"><div class="p-4"><h4 class="font-bold text-slate-800">${ad.title}</h4><p class="text-sm text-slate-500 mt-1">${ad.description}</p></div></div>`;
        const createWriterDashboard = (earnings) => { const totalEarnings = Object.values(earnings?.novels || {}).reduce((sum, val) => sum + val, 0); const canWithdraw = totalEarnings >= 300000; return `<div class="bg-white rounded-xl shadow-sm p-4 space-y-3"><div class="flex justify-between items-center"><p class="text-sm text-slate-500">Penghasilan Bulan Ini</p><p class="font-bold text-slate-800">Rp ${(earnings?.currentMonth || 0).toLocaleString('id-ID')}</p></div><div class="flex justify-between items-center"><p class="text-sm text-slate-500">Total Pendapatan</p><p class="font-bold text-lg text-green-600">Rp ${totalEarnings.toLocaleString('id-ID')}</p></div><button id="withdraw-btn" class="w-full font-semibold py-2.5 px-4 rounded-lg text-sm ${canWithdraw ? 'bg-green-500 text-white' : 'bg-slate-200 text-slate-400 cursor-not-allowed'}" ${!canWithdraw ? 'disabled' : ''}>${canWithdraw ? 'Tarik Tunai' : 'Saldo Belum Cukup'}</button></div>`;};
        
        // --- [FIX #3 - COMMENT] ---
        // Memperbaiki fungsi render komentar agar mengurutkan & menampilkan waktu.
        function renderComments(comments = []) {
            const sortedComments = (comments || []).sort((a, b) => {
                const dateA = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(a.createdAt || 0);
                const dateB = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(b.createdAt || 0);
                return dateB - dateA;
            });

            $('#comment-list-container').innerHTML = sortedComments.map(c => {
                const commentDate = c.createdAt?.toDate ? c.createdAt.toDate() : new Date(c.createdAt || 0);
                const timeString = commentDate.toLocaleString('id-ID', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });
                return `<div class="bg-gray-100 p-3 rounded-lg">
                    <div class="flex justify-between items-center">
                        <p class="text-xs font-bold text-pink-600">${c.user}</p>
                        <p class="text-xs text-slate-400">${timeString}</p>
                    </div>
                    <p class="text-sm text-slate-700 mt-1">${c.text}</p>
                </div>`;
            }).join('') || '<p class="text-sm text-slate-400 text-center py-4">Jadilah yang pertama berkomentar!</p>';
            
            $('#comment-count-badge').textContent = (comments || []).length;
        }

        const createBeliKoinPage = () => {$('#buy-coin-content').innerHTML = `<div class="space-y-6"> <div class="p-4 bg-yellow-50 border-l-4 border-yellow-400 rounded-r-lg"> <div class="flex items-center gap-3"> <i data-lucide="gem" class="w-8 h-8 text-yellow-500"></i> <div> <h3 class="font-bold text-yellow-900">Mata Uang & Pendapatan</h3> <p class="text-xs text-yellow-700">Koin Emas adalah mata uang utama di JoyiNovel. Setiap pembelian bab dengan Koin Emas akan dibagi 50/50 antara Penulis dan Admin.</p> </div> </div> </div> <div> <h4 class="font-bold text-slate-800 mb-2">Beli Koin Emas</h4> <div class="p-3 bg-yellow-50 rounded-lg text-xs mb-3"> <p class="font-semibold text-yellow-800">Keunggulan Koin Emas:</p> <ul class="list-disc list-inside text-yellow-700 mt-1"> <li>Bisa digunakan untuk membuka bab premium dari SEMUA penulis.</li> <li>Bisa digunakan oleh penulis untuk mempromosikan novel.</li> </ul> </div> <div class="space-y-3"> ${[{ price: 10000, gold: 100 },{ price: 20000, gold: 240 },{ price: 50000, gold: 600 }].map(p => `<div class="bg-white p-4 rounded-lg shadow-sm border"><div class="flex justify-between items-center"><div><p class="font-bold text-slate-800">${p.gold.toLocaleString('id-ID')} Koin Emas</p><p class="text-sm text-slate-500">Rp ${p.price.toLocaleString('id-ID')}</p></div><a href="#" data-package="${p.gold} Koin Emas" class="buy-coin-link bg-green-500 text-white font-semibold py-2 px-4 rounded-lg text-sm hover:bg-green-600">Beli</a></div></div>`).join('')} </div> </div> <div> <h4 class="font-bold text-slate-800 mb-2 mt-6">Beli Koin Perak</h4> <div class="p-3 bg-gray-50 rounded-lg text-xs mb-3"> <p class="font-semibold text-slate-700">Keunggulan Koin Perak:</p> <ul class="list-disc list-inside text-slate-600 mt-1"> <li>Harga lebih murah per koinnya.</li> <li>Mendukung penulis favorit secara langsung.</li> </ul> <p class="font-semibold text-slate-700 mt-2">Kekurangan:</p> <ul class="list-disc list-inside text-slate-600 mt-1"> <li>Hanya bisa digunakan untuk novel dari penulis tempat Anda membeli.</li> </ul> </div> <div class="bg-white p-4 rounded-lg shadow-sm border"> <div class="flex justify-between items-center"> <div> <p class="font-bold text-slate-800">150 Koin Perak</p> <p class="text-sm text-slate-500">Rp 10.000</p> </div> <button id="buy-silver-info-btn" class="bg-sky-500 text-white font-semibold py-2 px-4 rounded-lg text-sm hover:bg-sky-600">Beli dari Penulis</button> </div> </div> </div> </div>`};
        
        function renderMyNovels(){
            if (!currentUser) return;
            const myNovels = allNovels.filter(n => n.author === currentUser.email);
            const earningsByNovel = currentUser?.earnings?.novels || {};
            $('#novel-list-view').innerHTML = myNovels.length > 0
                ? myNovels.map(novel => createMyNovelCard(novel, earningsByNovel[novel.title] || 0)).join('')
                : `<div class="text-center mt-16"><i data-lucide="book-copy" class="w-20 h-20 text-pink-300 mx-auto"></i><h2 class="text-xl font-bold text-slate-800 mt-4">Novel Saya</h2><p class="text-slate-500 mt-1">Anda belum menambahkan novel.</p></div>`;
            lucide.createIcons();
        }
        function renderPustaka() {
            if (!currentUser) return;
            $('#pustaka-content').innerHTML = allNovels.filter(n => libraryNovelIds.includes(n.id)).map(n => createNovelCard(n, 'library')).join('') || `<div class="text-center mt-16"><i data-lucide="library" class="w-20 h-20 text-pink-300 mx-auto"></i><h2 class="text-xl font-bold text-slate-800 mt-4">Pustaka Kosong</h2><p class="text-slate-500 mt-1">Koleksi novel favoritmu di sini.</p></div>`;
            lucide.createIcons();
        }
        
        function renderAds() {
            const container = $('#admin-ads-container');
            if (!container) return;

            const validAds = adSlots.filter(ad => ad && ad.imageUrl && ad.imageUrl.trim() !== '');

            if (validAds.length > 0) {
                container.innerHTML = validAds.map(createAdCard).join('');
                logAdView('profile');
            } else {
                container.innerHTML = '';
            }
        }

        async function fetchNovelCount() {
            try {
                const metadataRef = doc(db, "metadata", "novels");
                const docSnap = await getDoc(metadataRef);
                if (docSnap.exists()) {
                    totalNovels = docSnap.data().count;
                } else {
                    console.warn("Dokumen metadata/novels tidak ditemukan.");
                    totalNovels = 0;
                }
            } catch (error) {
                console.error("Gagal mengambil total novel:", error);
            }
        }

        async function fetchJelajahPage(pageNumber) {
            const grid = $('#jelajah-grid');
            grid.innerHTML = '<p class="col-span-4 text-center text-slate-500 mt-8 animate-pulse">Memuat novel...</p>';
            
            try {
                const novelsRef = collection(db, "novels");
                const cursor = pageHistory[pageNumber - 1]; 
                
                let q = cursor 
                    ? query(novelsRef, orderBy("createdAt", "desc"), startAfter(cursor), limit(jelajahItemsPerPage))
                    : query(novelsRef, orderBy("createdAt", "desc"), limit(jelajahItemsPerPage));

                const documentSnapshots = await getDocs(q);
                
                if (!documentSnapshots.empty) {
                    pageHistory[pageNumber] = documentSnapshots.docs[documentSnapshots.docs.length - 1];
                }
                
                const novelsForPage = documentSnapshots.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                currentPage = pageNumber;
                renderJelajahUI(novelsForPage);

            } catch (error) {
                console.error("Gagal mengambil halaman novel:", error);
                grid.innerHTML = '<p class="col-span-4 text-center text-red-500 mt-8">Gagal memuat novel.</p>';
            }
        }

        function renderJelajahUI(novels) {
            const grid = $('#jelajah-grid');
            const paginationControls = $('#pagination-controls');

            grid.innerHTML = novels.length > 0 ? novels.map(createJelajahCard).join('') : `<p class="col-span-4 text-center text-slate-500 mt-8">Tidak ada novel yang ditemukan.</p>`;
            
            paginationControls.innerHTML = '';
            const totalPages = Math.ceil(totalNovels / jelajahItemsPerPage);

            if (totalPages > 1 && paginationControls.style.display !== 'none') {
                paginationControls.innerHTML += `<button data-page="prev" class="px-3 py-1 rounded-md bg-white border shadow-sm ${currentPage === 1 ? 'text-slate-300' : 'text-slate-700'}" ${currentPage === 1 ? 'disabled' : ''}><i data-lucide="chevron-left" class="w-4 h-4"></i></button>`;
                paginationControls.innerHTML += `<span class="text-sm font-medium text-slate-600">Hal ${currentPage} dari ${totalPages}</span>`;
                paginationControls.innerHTML += `<button data-page="next" class="px-3 py-1 rounded-md bg-white border shadow-sm ${currentPage === totalPages ? 'text-slate-300' : 'text-slate-700'}" ${currentPage === totalPages ? 'disabled' : ''}><i data-lucide="chevron-right" class="w-4 h-4"></i></button>`;
            }

            lucide.createIcons();
        }

        function loadContent() {
            const mainContainer = $('#page-beranda .p-4');
            mainContainer.innerHTML = ''; 
            homepageLayout.forEach(section => {
                if (!section.visible) return;

                let contentContainerId = `${section.id}-container`;
                let sectionHTML = `<div><h3 class="text-lg font-bold text-slate-800 mb-3">${section.title}</h3>`;

                if (section.id.startsWith('custom-')) {
                    sectionHTML += `<div id="${contentContainerId}" class="flex flex-nowrap gap-2 overflow-x-auto pb-3 -mx-4 px-4 hide-scrollbar"></div>`;
                } else {
                    switch(section.id) {
                        case 'sponsored':
                            sectionHTML += `<div id="${contentContainerId}-wrapper" class="w-full overflow-x-auto pb-3 -mx-4 px-4 hide-scrollbar slider-container"><div id="${contentContainerId}" class="flex gap-4 slider-track"></div></div>`;
                            break;
                        case 'trending':
                            sectionHTML += `<div id="${contentContainerId}" class="flex flex-nowrap gap-2 overflow-x-auto pb-3 -mx-4 px-4 hide-scrollbar"></div>`;
                            break;
                        case 'authors':
                            contentContainerId = 'author-track';
                            sectionHTML += `<div id="${contentContainerId}" class="flex flex-nowrap gap-2 overflow-x-auto pb-3 -mx-4 px-4 hide-scrollbar"></div>`;
                            break;
                        case 'recommendations':
                            sectionHTML += `<div id="${contentContainerId}" class="space-y-4"></div>`;
                            break;
                    }
                }

                sectionHTML += `</div>`;
                mainContainer.innerHTML += sectionHTML;

                const contentContainer = $(`#${contentContainerId}`);
                if (!contentContainer) return;

                if (section.id.startsWith('custom-')) {
                    if (section.novelIds && section.novelIds.length > 0) {
                        const selectedNovels = section.novelIds
                            .map(id => allNovels.find(novel => novel.id === id))
                            .filter(Boolean); 
                        
                        if (selectedNovels.length > 0) {
                            contentContainer.innerHTML = selectedNovels.map(createTrendingCard).join('');
                        } else {
                            contentContainer.innerHTML = `<p class="text-sm text-slate-400 text-center w-full">Novel untuk seksi ini tidak ditemukan.</p>`;
                        }
                    } else {
                        contentContainer.innerHTML = `<p class="text-sm text-slate-400 text-center w-full">Belum ada novel yang dipilih untuk seksi ini.</p>`;
                    }
                } else if (section.id === 'sponsored') {
                    const promotedNovels = allNovels.filter(n => {
                        if (n.isPromoted && n.promotedAt && typeof n.promotedAt.toDate === 'function') {
                            const promotedTime = n.promotedAt.toDate();
                            const expiryTime = new Date(promotedTime.getTime() + (24 * 60 * 60 * 1000));
                            return new Date() < expiryTime;
                        }
                        return false;
                    });

                    if (promotedNovels.length > 0) {
                        const baseHTML = promotedNovels.map(createSponsoredBannerCard).join('');
                        contentContainer.innerHTML = baseHTML.repeat(4);
                    } else {
                        $(`#${contentContainerId}-wrapper`).parentElement.style.display = 'none';
                    }
                } else if (section.id === 'trending') {
                    contentContainer.innerHTML = allNovels.filter(n => n.isTrending).slice(0, 7).map(createTrendingCard).join('');
                } else if (section.id === 'authors') {
                    contentContainer.innerHTML = dummyAuthors.map(createAuthorProfileCard).join('');
                } else if (section.id === 'recommendations') {
                    contentContainer.innerHTML = allNovels.slice(0, 4).map(n => createNovelCard(n, 'recommendation')).join('');
                }
            });
            
            renderPustaka();
        }

        function updateProfileView(){
            if (!currentUser) return;
            $('#profile-pen-name').textContent = currentUser.penName || 'Atur Nama Pena';
            $('#profile-email').textContent = currentUser.email;
            $('#profile-role').textContent = currentUser.role;
            $('#profile-avatar').src = currentUser.avatarUrl || `https://placehold.co/100x100/fecdd3/44403c?text=${(currentUser.penName || 'A').substring(0,1).toUpperCase()}`;
            const wB=$('#writer-action-button');
            if(currentUser.role==='penulis'){
                wB.innerHTML=`<i data-lucide="layout-dashboard" class="w-4 h-4"></i> Dasbor Penulis`;
            } else {
                wB.innerHTML=`<i data-lucide="edit-3" class="w-4 h-4"></i> Daftar Jadi Penulis`;
            }
            $('#contact-admin-button').href=`https://wa.me/6287745646067?text=${encodeURIComponent(`Halo Admin, saya ${currentUser.email}.`)}`;
            lucide.createIcons(); 
        }

        function applyReaderSettings(){const wrapper=$('#reader-content-wrapper');const page=$('#page-baca-bab');fontSizes.forEach(s=>wrapper.classList.remove(s));wrapper.classList.add(fontSizes[readerSettings.fontSize]);if(readerSettings.theme==='light'){page.className='page absolute inset-0 flex flex-col bg-white text-slate-800';}else if(readerSettings.theme==='sepia'){page.className='page absolute inset-0 flex flex-col bg-[#fbf5e9] text-[#5b4636]';}else{page.className='page absolute inset-0 flex flex-col bg-slate-900 text-slate-300';}}
        function checkAndResetEarnings(){if(!currentUser) return; const today=new Date();if(today.getDate()===2&&today.getDate()!==currentUser.earnings.lastReset){currentUser.earnings.currentMonth=0;currentUser.earnings.lastReset=2;showToast("Penghasilan bulanan telah direset.")}}
        
        function updateDynamicUI(pId='beranda',ctx=null){$$('.page').forEach(p=>p.classList.add('hidden'));const p=$(`#page-${pId}`); if(!p) { console.error(`Halaman tidak ditemukan: ${pId}`); return; } p.classList.remove('hidden');p.scrollTop=0;const pT={'beranda':'JoyiNovel','jelajah':'Jelajahi','pustaka':'Pustaka Saya','profil':'Profil Saya','dashboard-penulis':'Dasbor Penulis','tambah-novel':'Tambah Novel','detail-novel':'Detail Novel','edit-novel':'Edit Novel','edit-bab':'Edit Bab','beli-koin':'Beli Koin','baca-bab':'Baca Bab', 'notifikasi': 'Notifikasi', 'saldo': 'Saldo Koin', 'beri-koin-perak': 'Beri Koin Perak'};let hT=pT[pId]||'JoyiNovel'; if (pId==='jelajah') { pageHistory = [null]; currentPage = 1; fetchJelajahPage(1); }let sB=Object.keys(pT).slice(4).includes(pId);if(pId==='beranda'){createHomePageHeader(allNotifications)}else{$('#main-header').innerHTML=`${sB&&pId!=='baca-bab'?`<button id="back-btn" class="text-slate-600"><i data-lucide="arrow-left"></i></button>`:`<div></div>`}<h1 class="text-xl font-bold">${hT}</h1><div></div>`}if(pId==='baca-bab'){ $('#main-header').classList.add('hidden'); }else{$('#main-header').classList.remove('hidden');} $('#bottom-nav').style.display = (sB || pId === 'baca-bab') ? 'none' : 'block'; if(sB&&pId!=='baca-bab')$('#back-btn').addEventListener('click',()=>window.history.back());if(pId==='detail-novel'&&ctx?.novelId){const n=allNovels.find(n=>n.id==ctx.novelId);if(n)$('#novel-detail-content').innerHTML=createNovelDetailPage(n)}if(pId==='dashboard-penulis'){if(currentUser?.role==='penulis')$('#dashboard-earnings-view').innerHTML = createWriterDashboard(currentUser.earnings); renderMyNovels()}if(pId==='edit-novel'&&ctx?.novelId){const novelId = ctx.novelId; const n=allNovels.find(novel=>novel.id==novelId);if(n){$('#edit-novel-content').innerHTML=createEditNovelPage(n);$('#add-chapter-btn').dataset.novelId=novelId;
        $('#edit-novel-title').value = n.title;
        $('#edit-novel-synopsis').value = n.description;
        $('#edit-novel-tags').value = (n.tags || []).map(tag => tag.name).join(', ');
        }else{$('#edit-novel-content').innerHTML = `<p class="p-4 text-center text-red-500">Gagal memuat data novel.</p>`; console.error(`Novel with ID ${novelId} not found.`);}}
        
        if(pId==='edit-bab'){const n=allNovels.find(n=>n.id==ctx.novelId);const c=n?.chapters?.find(c=>c.id==ctx.chapterId);createEditChapterForm(c, n)}

        if(pId==='baca-bab' && ctx?.novelId && ctx?.chapterId){
            const n = allNovels.find(n => n.id == ctx.novelId);
            const c = n.chapters.find(c => c.id == ctx.chapterId);
            const contentWrapper = $('#reader-content-wrapper');
            $('#reader-toolbar').innerHTML = createReaderToolbar(n, c);
            
            if (n.monetizationModel === 'ads' && n.adScript) {
                logAdView('novel', n.id);
                
                const paragraphs = c.content.split(/\n+/).filter(p => p.trim() !== '');
                let finalContentHTML = '';
                const adInsertionInterval = 3; 

                paragraphs.forEach((p, index) => {
                    finalContentHTML += `<p>${p}</p>`;
                    if ((index + 1) % adInsertionInterval === 0 && (index + 1) < paragraphs.length) {
                        finalContentHTML += `<div class="my-6 flex justify-center items-center">${n.adScript}</div>`;
                    }
                });
                contentWrapper.innerHTML = finalContentHTML;
            } else {
                contentWrapper.innerHTML = `<p>${c.content.replace(/\n/g, '</p><p>')}</p>`;
            }

            renderComments(c.comments);
            applyReaderSettings();
        }
        
        if(pId==='notifikasi'){$('#notification-list').innerHTML = allNotifications.length > 0 ? allNotifications.map(createNotificationCard).join('') : '<p class="text-center text-slate-500 mt-8">Tidak ada notifikasi.</p>'}if(pId==='saldo'){$('#saldo-content').innerHTML = createSaldoPage(currentUser.balance)}if(pId==='beri-koin-perak'){createGiveSilverCoinForm()}if(pId==='beli-koin'){createBeliKoinPage()}
        
        if(pId==='tambah-novel'){$('#add-novel-form').innerHTML=`<div><label class="text-sm">Judul Novel</label><input type="text" id="novel-title" required class="mt-1 w-full border rounded-md text-sm p-2"></div><div><label class="text-sm">Nomor WhatsApp</label><input type="tel" id="author-phone" required placeholder="628..." class="mt-1 w-full border rounded-md text-sm p-2"></div><div><label class="text-sm">Genre (pisahkan koma)</label><input type="text" id="novel-tags" required class="mt-1 w-full border rounded-md text-sm p-2"></div><div><label class="text-sm">URL Cover (Opsional)</label><input type="url" id="novel-cover-url" class="mt-1 w-full border rounded-md text-sm p-2"><p class="text-xs text-slate-500 mt-1">Jika kosong, cover akan dibuat otomatis.</p></div><div><label class="text-sm">Sinopsis</label><textarea id="novel-synopsis" rows="6" required class="mt-1 w-full border rounded-md text-sm p-2"></textarea></div><div><label class="text-sm">Status</label><div class="mt-2 flex gap-4"><label><input type="radio" name="novel-status" value="Belum Tamat" checked><span class="ml-2 text-sm">Belum Tamat</span></label><label><input type="radio" name="novel-status" value="Tamat"><span class="ml-2 text-sm">Tamat</span></label></div></div><div class="p-3 bg-blue-50 border-l-4 border-blue-400 rounded-r-lg"><h4 class="font-bold text-sm text-blue-900 mb-2">Pilih Model Monetisasi</h4><div class="space-y-2"><label class="flex items-center"><input type="radio" name="monetization-model" value="paid" checked><span class="ml-2 text-sm text-slate-700">Bab Berbayar (Premium)</span></label><label class="flex items-center"><input type="radio" name="monetization-model" value="ads"><span class="ml-2 text-sm text-slate-700">Gratis (Didukung Iklan)</span></label></div></div><div id="ad-script-container" class="hidden"><label class="text-sm">Kode Iklan Pihak Ketiga</label><textarea id="novel-ad-script" rows="4" placeholder="Tempel kode iklan Anda di sini" class="mt-1 w-full border rounded-md text-sm p-2"></textarea><p class="text-xs text-slate-500 mt-1">Iklan akan ditampilkan di antara paragraf.</p></div><button type="submit" class="w-full bg-pink-500 text-white font-semibold py-2.5 rounded-lg mt-4">Simpan Novel</button>`}
        
        if(currentUser) updateProfileView();}

        function setupEventListeners(){
    let cNId,cCId;
    
    $('#logout-btn').addEventListener('click', () => { signOut(auth); }); 
    $('#nav-container').addEventListener('click',e=>{const n=e.target.closest('.nav-item');if(!n)return;e.preventDefault();const t=n.hash.substring(1);$$('.nav-item').forEach(i=>{i.classList.toggle('text-pink-500',i===n);i.classList.toggle('text-slate-500',i!==n);i.querySelector('span').classList.toggle('font-semibold',i===n)});history.pushState({page:t},'',`#${t}`);updateDynamicUI(t)});
    
    $('#writer-action-button').addEventListener('click',e=>{e.preventDefault();if(currentUser.role==='penulis')updateDynamicUI('dashboard-penulis');else $('#writer-signup-modal').classList.remove('hidden')});
    $('#profile-avatar').addEventListener('click',()=>$('#profile-options').classList.toggle('hidden'));
    $('#close-modal-btn').addEventListener('click', async () => { try { const userRef = doc(db, "users", currentUser.uid); await updateDoc(userRef, { role: 'penulis' }); currentUser.role = 'penulis'; showToast('Selamat, Anda sekarang adalah penulis!'); updateProfileView(); } catch (e) { showToast('Gagal memperbarui role.'); console.error(e); } finally {$('#writer-signup-modal').classList.add('hidden');}});
    
    $('#add-novel-btn').addEventListener('click', () => {
        history.pushState({ page: 'tambah-novel' }, '', '#tambah-novel');
        updateDynamicUI('tambah-novel');
    });

    $('#buy-coin-button').addEventListener('click', (e) => {
        e.preventDefault();
        history.pushState({ page: 'beli-koin' }, '', '#beli-koin');
        updateDynamicUI('beli-koin');
    });

    $('#saldo-koin-button').addEventListener('click', (e) => {
        e.preventDefault();
        history.pushState({ page: 'saldo' }, '', '#saldo');
        updateDynamicUI('saldo');
    });

    $('#main-header').addEventListener('click', e => {
        const sB = e.target.closest('#search-btn');
        if (sB) {
            history.pushState({ page: 'jelajah' }, '', '#jelajah');
            updateDynamicUI('jelajah');
        }

        const nB = e.target.closest('#notification-btn');
        if (nB) {
            history.pushState({ page: 'notifikasi' }, '', '#notifikasi');
            updateDynamicUI('notifikasi');
        }
    });
    
    $('#pagination-controls').addEventListener('click', e => {
        const button = e.target.closest('button');
        if (!button) return;
        const pageAction = button.dataset.page;
        if (pageAction === 'prev' && currentPage > 1) {
            fetchJelajahPage(currentPage - 1);
        } else if (pageAction === 'next') {
            const totalPages = Math.ceil(totalNovels / jelajahItemsPerPage);
            if (currentPage < totalPages) {
                fetchJelajahPage(currentPage + 1);
            }
        }
    });

    $('body').addEventListener('click', async e => { 
        if (e.target.classList.contains('modal')) e.target.classList.add('hidden');
        const closeBtn = e.target.closest('.close-modal-btn');
        if (closeBtn) closeBtn.closest('.modal')?.classList.add('hidden');

        const changePenNameBtn = e.target.closest('#change-pen-name-btn'); 
        if (changePenNameBtn) { 
            const newPenName = $('#pen-name-edit').value.trim(); 
            if (newPenName && newPenName !== currentUser.penName) { 
                try { 
                    const userRef = doc(db, "users", currentUser.uid); 
                    await updateDoc(userRef, { penName: newPenName }); 
                    const novelsQuery = query(collection(db, "novels"), where("author", "==", currentUser.email));
                    const querySnapshot = await getDocs(novelsQuery);
                    const batch = writeBatch(db);
                    querySnapshot.forEach((novelDoc) => batch.update(doc(db, "novels", novelDoc.id), { authorPenName: newPenName }));
                    await batch.commit();
                    currentUser.penName = newPenName;
                    allNovels.forEach(novel => { if (novel.author === currentUser.email) novel.authorPenName = newPenName; });
                    await refreshAuthorProfiles();
                    loadContent(); 
                    renderMyNovels();
                    updateProfileView();
                    showToast('Nama pena berhasil diperbarui!'); 
                } catch (err) { 
                    console.error(err); 
                    showToast('Gagal memperbarui nama pena.'); 
                } 
            } 
        }
        const changeAvatarBtn = e.target.closest('#change-avatar-btn');
        if (changeAvatarBtn) {
            let newAvatarUrl = $('#avatar-url').value;
            if (newAvatarUrl) {
                try {
                    const userRef = doc(db, "users", currentUser.uid);
                    await updateDoc(userRef, { avatarUrl: newAvatarUrl });
                    currentUser.avatarUrl = newAvatarUrl;
                    await refreshAuthorProfiles();
                    loadContent();
                    showToast('Foto profil berhasil diperbarui!');
                    updateProfileView();
                } catch(err){
                   console.error(err);
                   showToast('Gagal memperbarui foto profil.');
                }
            }
        }
        const shareBtnAction = (btn) => {
            e.preventDefault();
            const novelId=btn.dataset.novelId;
            const shareableLink=`${window.location.href.split('#')[0]}#detail-novel&id=${novelId}`;
            copyToClipboardFallback(shareableLink);
        };
        const sNB=e.target.closest('.share-novel-btn'); if(sNB) shareBtnAction(sNB);
        const shareDetailBtn = e.target.closest('#share-detail-btn'); if(shareDetailBtn) shareBtnAction(shareDetailBtn);
        
        const nC=e.target.closest('.novel-card');
        if(nC&&!e.target.closest('.delete-library-btn')){
            const nId=nC.dataset.novelId;
            incrementNovelClickCount(nId); 
            history.pushState({page:'detail-novel',novelId:nId},'');
            updateDynamicUI('detail-novel',{novelId:nId});
        }

        const dB=e.target.closest('.delete-library-btn');
        if(dB){ 
            const novelId = dB.dataset.novelId; 
            const index = libraryNovelIds.indexOf(novelId); 
            if (index > -1) { 
                libraryNovelIds.splice(index, 1); 
                try { 
                    await updateDoc(doc(db, "users", currentUser.uid), { library: libraryNovelIds }); 
                    dB.closest('.novel-card').remove(); 
                    showToast('Novel dihapus dari pustaka.'); 
                } catch(err) { 
                    console.error(err); 
                    showToast('Gagal menghapus novel dari pustaka.'); 
                    libraryNovelIds.push(novelId); 
                } 
            } 
        }

        const aL = e.target.closest('#add-to-library-btn');
        if (aL) {
            const nId = aL.dataset.novelId;
            if (!libraryNovelIds.includes(nId)) {
                libraryNovelIds.push(nId);
                try {
                    await updateDoc(doc(db, "users", currentUser.uid), { library: libraryNovelIds });
                    showToast('Novel ditambahkan ke koleksi!');
                    renderPustaka();
                } catch (err) {
                    console.error(err);
                    showToast('Gagal menambahkan ke koleksi.');
                    libraryNovelIds.pop();
                }
            } else {
                showToast('Novel sudah ada di koleksi.');
            }
        }

        const eNB=e.target.closest('.edit-novel-btn');if(eNB){cNId=eNB.dataset.novelId;history.pushState({page:'edit-novel',novelId:cNId},'');updateDynamicUI('edit-novel',{novelId:cNId})}
        const aCB=e.target.closest('#add-chapter-btn');if(aCB){cNId=aCB.dataset.novelId;cCId=null;history.pushState({page:'edit-bab',novelId:cNId},'');updateDynamicUI('edit-bab',{novelId:cNId, chapterId: null})}
        
        const pNB = e.target.closest('.promote-novel-btn');
        if (pNB) {
            const novelId = pNB.dataset.novelId;
            const novel = allNovels.find(n => n.id == novelId);
            if (novel && currentUser.balance.gold >= 50) {
                pNB.disabled = true;
                try {
                    const batch = writeBatch(db);
                    batch.update(doc(db, "novels", novelId), { isPromoted: true, promotedAt: new Date() });
                    const newGoldBalance = currentUser.balance.gold - 50;
                    batch.update(doc(db, "users", currentUser.uid), { "balance.gold": newGoldBalance });
                    await batch.commit();
                    currentUser.balance.gold = newGoldBalance;
                    novel.isPromoted = true;
                    novel.promotedAt = { toDate: () => new Date() };
                    showToast(`"${novel.title}" berhasil dipromosikan!`);
                    renderMyNovels();
                    loadContent();
                } catch (error) {
                    console.error("Gagal mempromosikan novel: ", error);
                    showToast('Gagal mempromosikan novel.');
                    pNB.disabled = false;
                }
            } else {
                showToast('Koin Emas tidak cukup (butuh 50).');
            }
        }

        const eCB=e.target.closest('.edit-chapter-btn');if(eCB){cCId=eCB.dataset.chapterId;history.pushState({page:'edit-bab',novelId:cNId,chapterId:cCId},'');updateDynamicUI('edit-bab',{novelId:cNId,chapterId:cCId})}
        const gSCB = e.target.closest('#give-silver-coin-btn'); if(gSCB){updateDynamicUI('beri-koin-perak')} 
        const bCL=e.target.closest('.buy-coin-link');if(bCL){const p=bCL.dataset.package;const m=encodeURIComponent(`Halo Admin, saya ${currentUser.email}, ingin membeli paket ${p}.`);window.open(`https://wa.me/6287745646067?text=${m}`,'_blank')}
        const aLi=e.target.closest('.author-link, .author-card');if(aLi){const a=aLi.dataset.author;history.pushState({page:'jelajah',author:a},'');updateDynamicUI('jelajah',{author:a})}
        const gT=e.target.closest('.genre-tag');if(gT){e.stopPropagation();const g=gT.dataset.genre;history.pushState({page:'jelajah',genre:g},'');updateDynamicUI('jelajah',{genre:g})}
        
        const cL=e.target.closest('.chapter-link');
        if(cL){
            e.preventDefault();
            const nId=cL.dataset.novelId;
            const cId=cL.dataset.chapterId;
            cNId=nId; 
            cCId=cId; 
            
            const n=allNovels.find(n=>n.id==nId);
            const c=n.chapters.find(c=>c.id==cId); 
            const isAdSupported = n.monetizationModel === 'ads';
            
            if(isAdSupported || c.monetization==='free'||unlockedChapterIds.includes(cId)){
                history.pushState({page:'baca-bab',novelId:nId,chapterId:cId},'');
                updateDynamicUI('baca-bab',{novelId:nId,chapterId:cId});
            } else {
                $('#unlock-chapter-modal-content').innerHTML=createUnlockModal(c,n);
                $('#unlock-chapter-modal').classList.remove('hidden');
                lucide.createIcons();
            }
        }

        const uWC=e.target.closest('.unlock-with-coin-btn');if(uWC){const canUnlock=uWC.dataset.canUnlock==='true';const coinType=uWC.dataset.coinType;const novel=allNovels.find(n=>n.id==cNId);if(!canUnlock){$('#unlock-chapter-modal').classList.add('hidden');if(coinType==='gold'){showToast('Koin Emas tidak cukup. Silakan top up.');updateDynamicUI('beli-koin')}else{$('#coin-info-modal-content').innerHTML = createCoinInfoModal(novel.authorPhone); $('#coin-info-modal').classList.remove('hidden'); lucide.createIcons();}}else{const chapter=novel.chapters.find(c=>c.id==cCId); if(coinType==='gold'){currentUser.balance.gold-=10}else{currentUser.balance.silver[novel.authorPenName] = (currentUser.balance.silver[novel.authorPenName] || 0) - 10;} unlockedChapterIds.push(chapter.id); try { await updateDoc(doc(db, "users", currentUser.uid), { balance: currentUser.balance, unlockedChapters: unlockedChapterIds }); $('#unlock-chapter-modal').classList.add('hidden'); showToast(`Bab "${chapter.title}" berhasil dibuka!`); history.pushState({page:'baca-bab',novelId:cNId,chapterId:cCId},''); updateDynamicUI('baca-bab',{novelId:cNId,chapterId:cCId}); } catch(err) { console.error(err); showToast('Gagal membuka bab.'); if(coinType==='gold'){currentUser.balance.gold+=10}else{currentUser.balance.silver[novel.authorPenName]+=10;} unlockedChapterIds.pop(); } }}
        const bgcr = e.target.closest('#buy-gold-coin-redirect'); if(bgcr){$('#coin-info-modal').classList.add('hidden');history.pushState({page:'beli-koin'},'', '#beli-koin');updateDynamicUI('beli-koin');} 
        const wD=e.target.closest('#withdraw-btn');if(wD){const m=encodeURIComponent(`Halo Admin, saya ${currentUser.email}, ingin melakukan penarikan dana.`);window.open(`https://wa.me/6287745646067?text=${m}`,'_blank')} 
        const rsB=e.target.closest('#reader-settings-btn');if(rsB){const m=$('#reader-settings-menu');if(m){m.remove()}else{$('#reader-toolbar').insertAdjacentHTML('beforeend',`<div id="reader-settings-menu" class="absolute top-full right-2 bg-white rounded-lg shadow-lg border mt-2 w-48">${createReaderSettingsMenu()}</div>`)}}
        const bfrB=e.target.closest('#back-from-reader');if(bfrB){window.history.back()}
        const df=e.target.closest('#decrease-font');if(df){if(readerSettings.fontSize>0)readerSettings.fontSize--;applyReaderSettings()}
        const iF=e.target.closest('#increase-font');if(iF){if(readerSettings.fontSize<fontSizes.length-1)readerSettings.fontSize++;applyReaderSettings()}
        const themeBtn = e.target.closest('[id^="theme-"]'); if(themeBtn){readerSettings.theme = themeBtn.id.split('-')[1]; applyReaderSettings();}
        const tsb = e.target.closest('.topup-silver-btn'); if(tsb){const authorName = tsb.dataset.authorName; const author = dummyAuthors.find(a => a.name === authorName); if(author?.phone){const msg = encodeURIComponent(`Halo kak ${authorName}, saya ingin top up Koin Perak.`); window.open(`https.wa.me/${author.phone}?text=${msg}`,'_blank');}} 
        const tgb = e.target.closest('#topup-gold-btn'); if(tgb){history.pushState({page:'beli-koin'},'', '#beli-koin'); updateDynamicUI('beli-koin');} 
        const bsib = e.target.closest('#buy-silver-info-btn'); if(bsib){showToast('Pilih penulis dari halaman Saldo Koin.'); history.pushState({page:'saldo'},'', '#saldo'); updateDynamicUI('saldo');}
        const openCommentBtn = e.target.closest('#open-comment-drawer-btn');
        if(openCommentBtn) {
            const novel = allNovels.find(n => n.id == cNId);
            if (novel) {
                const chapter = novel.chapters.find(c => c.id == cCId);
                if (chapter) renderComments(chapter.comments);
            }
            $('#comment-drawer').classList.remove('hidden');
            setTimeout(() => $('#comment-drawer-content').classList.remove('translate-y-full'), 10);
        }
        const closeCommentBtn = e.target.closest('#close-comment-drawer-btn');
        if(closeCommentBtn || e.target.id === 'comment-drawer') {
            $('#comment-drawer-content').classList.add('translate-y-full');
            setTimeout(() => $('#comment-drawer').classList.add('hidden'), 300);
        }
    });
    
    $('body').addEventListener('input',e=>{
        if(e.target.id==='monetize-toggle'){$('#monetize-options').classList.toggle('hidden',!e.target.checked)}
        if(e.target.id==='ai-percentage'){$('#ai-percentage-label').textContent=`${e.target.value}% AI`}
        if(e.target.id==='chapter-content'){const wC=e.target.value.trim().split(/\s+/).filter(Boolean).length;$('#word-count').textContent=`${wC}/1000 kata minimum`;$('#word-count').classList.toggle('text-green-600',wC>=1000)}
        
        if(e.target.id==='search-input'){
            const q = e.target.value.toLowerCase().trim();
            const paginationControls = $('#pagination-controls');
            if (q.length > 0) {
                paginationControls.style.display = 'none';
                const searchResults = allNovels.filter(n => n.title.toLowerCase().includes(q) || (n.authorPenName && n.authorPenName.toLowerCase().includes(q)));
                renderJelajahUI(searchResults);
            } else {
                paginationControls.style.display = 'flex';
                fetchJelajahPage(1);
            }
        }
    });

    $('body').addEventListener('change', e => {
        if (e.target.name === 'monetization-model') {
            $('#ad-script-container')?.classList.toggle('hidden', e.target.value !== 'ads');
        }
    });

    $('body').addEventListener('focusin', e => {
        if (e.target.id === 'comment-input') {
            setTimeout(() => $('#comment-drawer-content').scrollIntoView({ behavior: 'smooth', block: 'end' }), 300); 
        }
    });

    $('body').addEventListener('submit', async e => {
        e.preventDefault();

        if(e.target.id === 'edit-novel-form') {
            const updatedData = {
                title: $('#edit-novel-title').value.trim(),
                description: $('#edit-novel-synopsis').value.trim(),
                tags: $('#edit-novel-tags').value.split(',').map(name => ({ name: name.trim() })).filter(tag => tag.name)
            };
            try {
                await updateDoc(doc(db, "novels", cNId), updatedData);
                const novelIndex = allNovels.findIndex(n => n.id === cNId);
                if (novelIndex > -1) allNovels[novelIndex] = { ...allNovels[novelIndex], ...updatedData };
                showToast('Detail novel berhasil diperbarui!');
                window.history.back();
            } catch (error) {
                console.error("Gagal memperbarui novel:", error);
                showToast('Gagal memperbarui detail novel.');
            }
        }

        if(e.target.id === 'add-novel-form'){ 
            const f=e.target; 
            let coverUrl = f['novel-cover-url'].value.trim();
            const title = f['novel-title'].value;
            if (!coverUrl) coverUrl = `https://placehold.co/400x600/fecdd3/44403c?text=${encodeURIComponent(title.split(' ').slice(0, 2).join(' '))}`;
            const monetizationModel = f['monetization-model'].value;
            const newNovel={ 
                title: title, 
                author:currentUser.email, 
                authorPenName: currentUser.penName, 
                authorPhone:f['author-phone'].value, 
                coverUrl: coverUrl,
                description:f['novel-synopsis'].value, 
                tags:f['novel-tags'].value.split(',').map(name=>({name:name.trim()})), 
                status:f['novel-status'].value, 
                chapters:[], 
                createdAt: new Date(),
                clickCount: 0,
                monetizationModel: monetizationModel,
                adScript: (monetizationModel === 'ads') ? f['novel-ad-script'].value.trim() : null
            }; 

            try { 
                const docRef = await addDoc(collection(db, "novels"), newNovel); 
                const newNovelForState = { id: docRef.id, ...newNovel, createdAt: { toDate: () => newNovel.createdAt } };
                allNovels.unshift(newNovelForState);
                f.reset(); 
                showToast('Novel berhasil disimpan!'); 
                updateDynamicUI('dashboard-penulis'); 
                
                try {
                    await updateDoc(doc(db, "metadata", "novels"), { count: increment(1) });
                    totalNovels++;
                } catch (metaError) {
                    console.error("Gagal memperbarui metadata, tapi novel sudah ditambahkan:", metaError);
                }

            } catch (error) { 
                console.error("Gagal menambahkan dokumen novel: ", error); 
                showToast('Gagal menyimpan novel.'); 
            } 
        }
        
        if(e.target.id==='edit-chapter-form'){ 
            const action = e.submitter.dataset.action;
            const novelId = $('#chapter-form-novel-id').value;
            const novelToUpdate = allNovels.find(n => n.id == novelId); 
            if(!novelToUpdate) { showToast("Error: Novel tidak ditemukan."); return; }
            let monetization = novelToUpdate.monetizationModel === 'paid' ? (e.target.querySelector('#monetize-toggle')?.checked ? 'paid' : 'free') : 'free';
            const content = $('#chapter-content').value;
            const wordCount = content.trim().split(/\s+/).filter(Boolean).length;
            if (action === 'publish' && monetization === 'paid' && wordCount < 1000) {
                showToast(`Gagal. Bab berbayar harus minimal 1000 kata. (Saat ini: ${wordCount} kata)`);
                return;
            }
            const chapterData = { 
                id: cCId || Date.now().toString(), 
                title: $('#chapter-title').value, 
                monetization: monetization, 
                ai_percent: $('#ai-percentage').value, 
                content: content,
                comments: novelToUpdate.chapters?.find(c => c.id == cCId)?.comments || [],
                status: action === 'publish' ? 'published' : 'draft'
            }; 
            let updatedChapters = cCId ? novelToUpdate.chapters.map(c => c.id == cCId ? chapterData : c) : [...(novelToUpdate.chapters || []), chapterData]; 
            try { 
                await updateDoc(doc(db, "novels", novelId), { chapters: updatedChapters }); 
                novelToUpdate.chapters = updatedChapters; 
                showToast(`Bab berhasil disimpan sebagai ${action === 'draft' ? 'draf' : 'publikasi'}!`); 
                window.history.back(); 
            } catch (error) { 
                console.error("Error updating chapter: ", error); 
                showToast("Gagal menyimpan bab."); 
            } 
        }
        
        if(e.target.id === 'give-silver-coin-form'){
            const email = $('#reader-email').value;
            const amount = parseInt($('#silver-amount').value, 10);
            if (!email || !amount || amount <= 0) { showToast('Email dan jumlah koin harus valid.'); return; }
            try {
                const q = query(collection(db, "users"), where("email", "==", email));
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) { showToast('Pengguna tidak ditemukan.'); return; }
                const recipientDoc = querySnapshot.docs[0];
                await updateDoc(doc(db, "users", recipientDoc.id), {
                    [`balance.silver.${currentUser.penName}`]: increment(amount)
                });
                showToast(`${amount} koin perak berhasil dikirim!`);
                e.target.reset();
                updateDynamicUI('dashboard-penulis');
            } catch (error) {
                console.error("Gagal mengirim koin perak:", error);
                showToast('Gagal mengirim koin perak.');
            }
        }
        
        if(e.target.id === 'comment-form'){ 
            const input = $('#comment-input'); 
            const text = input.value.trim(); 
            if(text && cNId && cCId){ 
                const newComment = {
                    user: currentUser.penName || currentUser.email.split('@')[0],
                    text: text,
                    createdAt: new Date()
                };
                const novelRef = doc(db, "novels", cNId);

                try {
                    const novelDoc = await getDoc(novelRef);
                    if (!novelDoc.exists()) throw new Error("Novel tidak ditemukan");
                    
                    const novelData = novelDoc.data();
                    const chapters = novelData.chapters || [];
                    const chapterIndex = chapters.findIndex(c => c.id == cCId);
                    if (chapterIndex === -1) throw new Error("Bab tidak ditemukan");
                    
                    if (!chapters[chapterIndex].comments) {
                        chapters[chapterIndex].comments = [];
                    }
                    
                    chapters[chapterIndex].comments.push(newComment);
                    
                    await updateDoc(novelRef, { chapters: chapters });
                    
                    const localNovel = allNovels.find(n => n.id == cNId);
                    if (localNovel) localNovel.chapters = chapters;
                    
                    renderComments(chapters[chapterIndex].comments);
                    input.value = '';
                } catch(err){ 
                    console.error("Gagal mengirim komentar:", err); 
                    showToast("Gagal mengirim komentar."); 
                } 
            } 
        }
    });
    
    window.addEventListener('popstate',e=>{const p=e.state?.page||'beranda';updateDynamicUI(p,e.state)});
}
        
        async function refreshAuthorProfiles() {
            const authorEmails = [...new Set(allNovels.map(n => n.author))];
            dummyAuthors = await Promise.all(authorEmails.map(async (email) => {
                const q = query(collection(db, "users"), where("email", "==", email), limit(1));
                const querySnapshot = await getDocs(q);
                const defaultName = email.split('@')[0];
                const defaultAvatar = `https://placehold.co/100x100/fecdd3/44403c?text=${(defaultName).substring(0,2).toUpperCase()}`;
                if (!querySnapshot.empty) {
                    const authorData = querySnapshot.docs[0].data();
                    return { 
                        name: authorData.penName || defaultName, 
                        avatarUrl: authorData.avatarUrl || defaultAvatar,
                        phone: authorData.phone || null
                    };
                }
                return { name: defaultName, avatarUrl: defaultAvatar, phone: null};
            }));
        }

        async function main() {
            onAuthStateChanged(auth, async (user) => {
                if (!user) {
                    $('#loading-indicator').classList.add('hidden');
                    $('#app-container').classList.add('hidden');
                    const authPage = $('#page-auth');
                    authPage.innerHTML = createAuthPage();
                    authPage.addEventListener('click', (e) => {
                        if (e.target.id === 'show-register-form-btn' || e.target.id === 'show-login-form-btn') {
                            const isLogin = e.target.id === 'show-login-form-btn';
                            $('#pen-name-field-register').style.display = isLogin ? 'none' : 'block';
                            $('#register-btn').classList.toggle('hidden', isLogin);
                            $('#login-btn').classList.toggle('hidden', !isLogin);
                            e.target.textContent = isLogin ? 'Belum punya akun? Daftar' : 'Sudah punya akun? Masuk';
                            e.target.id = isLogin ? 'show-register-form-btn' : 'show-login-form-btn';
                        }
                        
                        if(e.target.id === 'login-btn' || e.target.id === 'register-btn'){
                            const email = $('#auth-email').value;
                            const password = $('#auth-password').value;
                            const errorDiv = $('#auth-error');
                            errorDiv.textContent = '';
                            if(e.target.id === 'login-btn'){
                                signInWithEmailAndPassword(auth, email, password).catch(error => { errorDiv.textContent = getFriendlyAuthError(error.code) });
                            } else {
                                const penName = $('#auth-pen-name').value;
                                if (!penName.trim()) { errorDiv.textContent = 'Nama pena wajib diisi.'; return; }
                                createUserWithEmailAndPassword(auth, email, password)
                                    .then(userCredential => setDoc(doc(db, "users", userCredential.user.uid), {
                                        email: userCredential.user.email, penName: penName, role: 'pembaca',
                                        balance: { gold: 0, silver: {} }, earnings: { currentMonth: 0, novels: {}, lastReset: 1 },
                                        library: [], unlockedChapters: [], createdAt: new Date()
                                    }))
                                    .catch(error => { errorDiv.textContent = getFriendlyAuthError(error.code) });
                            }
                        }
                    });
                    authPage.classList.remove('hidden');
                } else {
                    $('#page-auth').classList.add('hidden');
                    $('#loading-indicator').classList.remove('hidden');
                    $('#app-container').classList.add('hidden');

                    try {
                        const userDocRef = doc(db, "users", user.uid);
                        const userDocSnap = await getDoc(userDocRef);
                        const defaultProfile = { email: user.email, penName: user.email.split('@')[0], role: 'pembaca', balance: { gold: 0, silver: {} }, earnings: { currentMonth: 0, novels: {}, lastReset: 1 }, library: [], unlockedChapters: [] };
                        if (userDocSnap.exists()) {
                            const dbData = userDocSnap.data();
                            currentUser = { ...defaultProfile, ...dbData, uid: user.uid, balance: { ...defaultProfile.balance, ...(dbData.balance || {}) }, earnings: { ...defaultProfile.earnings, ...(dbData.earnings || {}) } };
                        } else {
                            await setDoc(userDocRef, defaultProfile);
                            currentUser = { uid: user.uid, ...defaultProfile };
                        }
                        libraryNovelIds = currentUser.library || [];
                        unlockedChapterIds = currentUser.unlockedChapters || [];
                        
                        const [ novelsSnapshot, adsSettingsDoc, homepageLayoutDoc, notificationsSnapshot ] = await Promise.all([
                            getDocs(query(collection(db, "novels"), orderBy("createdAt", "desc"))),
                            getDoc(doc(db, "settings", "ads")),
                            getDoc(doc(db, "settings", "homepageLayout")),
                            getDocs(collection(db, "notifications")),
                            fetchNovelCount()
                        ]);

                        allNovels = novelsSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                        
                        if (adsSettingsDoc.exists()) {
                            adSlots = adsSettingsDoc.data().profileAds || [];
                        }
                        
                        if (homepageLayoutDoc.exists()) homepageLayout = homepageLayoutDoc.data().sections.sort((a, b) => a.order - b.order) || [];
                        
                        const rawNotifications = notificationsSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                        allNotifications = rawNotifications.filter(n => n.target === 'all' || n.target === currentUser.role).sort((a, b) => b.createdAt.seconds - a.createdAt.seconds);
                        await refreshAuthorProfiles();
                    } catch (error) {
                        console.error("Gagal mengambil data dari Firebase:", error);
                        $('#app-container').classList.add('hidden');
                        $('#loading-indicator').innerHTML = `<div class="text-center p-4"><p class="text-red-500 font-semibold">Gagal mengambil data.</p><p class="text-sm text-slate-500 mt-1">Pastikan koneksi internet stabil.</p></div>`;
                        $('#loading-indicator').classList.remove('hidden');
                        return;
                    }
                    $('#loading-indicator').classList.add('hidden');
                    $('#app-container').classList.remove('hidden');
                    initializeAppUI();
                }
            });
        }

        function initializeAppUI() {
            checkAndResetEarnings();
            loadContent();
            renderAds(); 
            const hash = window.location.hash;
            if (hash.includes('#detail-novel&id=')) {
                const novelId = hash.split('=')[1];
                if (novelId) {
                    history.replaceState({ page: 'detail-novel', novelId: novelId }, '', `#detail-novel`);
                    updateDynamicUI('detail-novel', { novelId: novelId });
                }
            } else {
                const initialPage = hash.substring(1) || 'beranda';
                history.replaceState({ page: initialPage }, '', `#${initialPage}`);
                updateDynamicUI(initialPage);
            }
            setupEventListeners();
            lucide.createIcons();
        }
        
        document.addEventListener('DOMContentLoaded', main);
    </script>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                .then(registration => console.log('ServiceWorker registration successful'))
                .catch(error => console.log('ServiceWorker registration failed: ', error));
            });
        }
    </script>
</body>
</html>
